<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Checkout - attest.ink</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div class="container">
        <h1>Test Checkout Flow</h1>
        
        <div class="section">
            <h2>Test California Tax Calculation</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                <input type="email" id="test-email" placeholder="Email" value="aharshbe@pm.me" style="flex: 1; min-width: 200px;">
                <input type="text" id="test-zipcode" placeholder="ZIP code" maxlength="10" style="width: 120px;">
                <button id="test-checkout" class="btn btn-primary">Test Checkout</button>
            </div>
            
            <div id="test-results" style="margin-top: 20px; padding: 15px; background: var(--bg-panel); border-radius: 8px; display: none;">
                <h3>Test Results:</h3>
                <pre id="results-content" style="white-space: pre-wrap; word-break: break-all;"></pre>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Test ZIP Codes:</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>90210</strong> - Los Angeles (9.5% tax)</li>
                    <li><strong>94105</strong> - San Francisco (8.75% tax)</li>
                    <li><strong>92101</strong> - San Diego (7.75% tax)</li>
                    <li><strong>95814</strong> - Sacramento (7.25% tax)</li>
                    <li><strong>10001</strong> - New York (no CA tax)</li>
                </ul>
            </div>
        </div>
        
        <div id="checkout-container" style="margin-top: 30px; display: none;">
            <!-- Stripe Embedded Checkout will be mounted here -->
        </div>
    </div>
    
    <script>
        document.getElementById('test-checkout').addEventListener('click', async () => {
            const email = document.getElementById('test-email').value.trim();
            const zipCode = document.getElementById('test-zipcode').value.trim();
            const resultsDiv = document.getElementById('test-results');
            const resultsContent = document.getElementById('results-content');
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            resultsDiv.style.display = 'block';
            resultsContent.textContent = 'Creating checkout session...';
            
            try {
                // Calculate expected tax
                let expectedTax = 0;
                let taxRate = 0;
                if (zipCode && zipCode.length >= 2) {
                    const prefix = parseInt(zipCode.substring(0, 2));
                    if (prefix >= 90 && prefix <= 96) {
                        // Simplified tax rates
                        const taxRates = {
                            '90': 0.095, '91': 0.095,  // LA
                            '92': 0.0775,               // San Diego
                            '93': 0.0875,               // Santa Barbara
                            '94': 0.0875,               // SF Bay Area
                            '95': 0.0875,               // San Jose
                            '96': 0.0725                // Sacramento
                        };
                        taxRate = taxRates[zipCode.substring(0, 2)] || 0.0725;
                        expectedTax = 20 * taxRate;
                    }
                }
                
                const response = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email,
                        zipCode,
                        attestationData: { test: true, timestamp: new Date().toISOString() },
                        attestationId: 'test-' + Date.now()
                    })
                });
                
                const data = await response.json();
                
                let results = `Response Status: ${response.status}\n\n`;
                results += `ZIP Code: ${zipCode || '(none)'}\n`;
                results += `Expected Tax Rate: ${(taxRate * 100).toFixed(2)}%\n`;
                results += `Expected Tax Amount: $${expectedTax.toFixed(2)}\n`;
                results += `Expected Total: $${(20 + expectedTax).toFixed(2)}\n\n`;
                results += 'API Response:\n' + JSON.stringify(data, null, 2);
                
                resultsContent.textContent = results;
                
                if (data.clientSecret) {
                    resultsContent.textContent += '\n\nâœ… Checkout session created successfully!';
                    resultsContent.textContent += '\n\nYou can now click "Open Test Checkout" to see the Stripe checkout form.';
                    
                    // Add button to open checkout
                    const checkoutBtn = document.createElement('button');
                    checkoutBtn.className = 'btn btn-primary';
                    checkoutBtn.textContent = 'Open Test Checkout';
                    checkoutBtn.style.marginTop = '15px';
                    checkoutBtn.onclick = async () => {
                        const stripe = Stripe('pk_test_51RnmhPCS9p44gPz1OJCQxT03PN5Vww2KZCW6zzKfJyW1qCF1fIgGxLbxe3cOgv4GHiM9ND0jvQOqrTTQQvGjbcGa00cKCt0Ugw');
                        const checkout = await stripe.initEmbeddedCheckout({
                            clientSecret: data.clientSecret,
                        });
                        
                        const container = document.getElementById('checkout-container');
                        container.style.display = 'block';
                        container.innerHTML = '<div id="checkout"></div>';
                        checkout.mount('#checkout');
                    };
                    
                    if (!document.getElementById('open-checkout-btn')) {
                        checkoutBtn.id = 'open-checkout-btn';
                        resultsDiv.appendChild(checkoutBtn);
                    }
                }
                
            } catch (error) {
                resultsContent.textContent = 'Error: ' + error.message;
            }
        });
        
        // Add some test buttons for quick testing
        const testButtons = [
            { zip: '90210', label: 'LA (9.5%)' },
            { zip: '94105', label: 'SF (8.75%)' },
            { zip: '92101', label: 'SD (7.75%)' },
            { zip: '10001', label: 'NY (no tax)' }
        ];
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;';
        
        testButtons.forEach(({ zip, label }) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-secondary';
            btn.textContent = label;
            btn.style.fontSize = '12px';
            btn.onclick = () => {
                document.getElementById('test-zipcode').value = zip;
            };
            buttonContainer.appendChild(btn);
        });
        
        document.querySelector('.section').insertBefore(buttonContainer, document.getElementById('test-results'));
    </script>
</body>
</html>